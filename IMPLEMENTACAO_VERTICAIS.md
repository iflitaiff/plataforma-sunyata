# Sistema de Verticais - Implementa√ß√£o Completa

## üìã Resumo

Este documento descreve a implementa√ß√£o completa do **Sistema de Verticais** na Plataforma Sunyata, transformando o portal de acesso universal para um sistema segmentado por √°reas de atua√ß√£o.

**Data de Implementa√ß√£o:** Outubro 2025
**Vers√£o:** 1.0

---

## ‚úÖ O que foi implementado

### FASE 1: Urgente (‚úÖ COMPLETO)

#### ‚úÖ SUBTAREFA 1: Schema do Banco de Dados

**Arquivos criados:**
- `config/migrations/001_vertical_system.sql` - Migration SQL com todas as altera√ß√µes
- `scripts/apply-migration.php` - Script CLI para aplicar migrations de forma segura
- `config/migrations/README.md` - Documenta√ß√£o completa do sistema de migrations

**Altera√ß√µes no banco:**

1. **Tabela `users`** - 3 novas colunas:
   ```sql
   selected_vertical ENUM('docencia', 'pesquisa', 'ifrj_alunos', 'juridico', 'vendas', 'marketing', 'licitacoes', 'rh', 'geral')
   completed_onboarding BOOLEAN DEFAULT FALSE
   is_demo BOOLEAN DEFAULT FALSE
   ```

2. **Nova tabela `user_profiles`:**
   - Dados estendidos do usu√°rio (telefone, cargo, organiza√ß√£o, etc)
   - Campos espec√≠ficos para IFRJ (n√≠vel de ensino, curso)

3. **Nova tabela `vertical_access_requests`:**
   - Solicita√ß√µes de acesso a verticais que requerem aprova√ß√£o (Jur√≠dico)
   - Status: pending, approved, rejected
   - JSON field para dados flex√≠veis da solicita√ß√£o

4. **Nova tabela `tool_access_logs`:**
   - Log de cada acesso a ferramentas
   - Para analytics e LGPD
   - Campos: user_id, tool_slug, vertical, IP, user_agent, timestamp

5. **Nova tabela `tool_versions`:**
   - Versionamento de arquivos HTML das ferramentas
   - Para rollback e hist√≥rico

6. **View `v_tool_access_stats`:**
   - Estat√≠sticas pr√©-calculadas para analytics

#### ‚úÖ SUBTAREFA 2: Fluxo de Onboarding

**Arquivos criados:**

1. **`public/onboarding-step1.php`**
   - Coleta dados pessoais/profissionais ap√≥s primeiro login Google
   - Campos: phone, position (obrigat√≥rio), organization, organization_size, area
   - Salva em `user_profiles`

2. **`public/onboarding-step2.php`**
   - Interface visual para escolha de vertical
   - Cards com descri√ß√£o, √≠cones e ferramentas de cada vertical
   - Badges: "Em breve", "Requer aprova√ß√£o"
   - JavaScript para roteamento inteligente

3. **`public/onboarding-save-vertical.php`**
   - Processa verticais diretas (n√£o requerem aprova√ß√£o/info extra)
   - Atualiza `users.selected_vertical` e `completed_onboarding`
   - Redireciona para √°rea da vertical

4. **`public/onboarding-ifrj.php`**
   - Formul√°rio espec√≠fico para alunos do IFRJ
   - Campos: ifrj_level (ensino_medio/superior), ifrj_course
   - Salva em `user_profiles` e completa onboarding

5. **`public/onboarding-juridico.php`**
   - Formul√°rio de solicita√ß√£o para vertical Jur√≠dico
   - Campos: profissao, oab (opcional, com valida√ß√£o), escritorio, motivo
   - Envia email para admin
   - Salva em `vertical_access_requests` com status pending
   - Sugere escolher outra vertical enquanto aguarda

**Integra√ß√£o:**
- ‚úÖ **`public/callback.php`** atualizado para verificar `completed_onboarding`
- Redireciona automaticamente para onboarding se necess√°rio

#### ‚úÖ SUBTAREFA 3: Estrutura de Verticais

**Diret√≥rios criados:**
```
public/areas/
‚îú‚îÄ‚îÄ docencia/
‚îú‚îÄ‚îÄ pesquisa/
‚îú‚îÄ‚îÄ ifrj-alunos/
‚îú‚îÄ‚îÄ juridico/
‚îú‚îÄ‚îÄ vendas/
‚îú‚îÄ‚îÄ marketing/
‚îú‚îÄ‚îÄ licitacoes/
‚îú‚îÄ‚îÄ rh/
‚îî‚îÄ‚îÄ geral/
```

**Arquivos gerados:**

1. **Script `scripts/generate-vertical-indexes.php`**
   - Gera automaticamente `index.php` para todas as 9 verticais
   - Verticais dispon√≠veis: interface completa com grid de ferramentas
   - Verticais indispon√≠veis: p√°gina "Em breve" estilizada

2. **Script `scripts/generate-tool-gateways.php`**
   - Gera automaticamente gateways PHP para todas as ferramentas
   - Total: **16 gateways criados**
   - Cada gateway:
     - Verifica login e acesso √† vertical
     - Registra acesso em `tool_access_logs`
     - Embeda HTML da ferramenta via `readfile()`
     - Tratamento de erros (404 se ferramenta n√£o existe)

**Mapeamento Ferramenta ‚Üí Vertical:**
- **Doc√™ncia:** canvas-docente, canvas-pesquisa, biblioteca-prompts-jogos, guia-prompts-jogos, repositorio-prompts
- **Pesquisa:** canvas-docente, canvas-pesquisa, repositorio-prompts
- **IFRJ-Alunos:** biblioteca-prompts-jogos, guia-prompts-jogos, canvas-pesquisa, repositorio-prompts
- **Jur√≠dico:** canvas-juridico, guia-prompts-juridico, padroes-avancados-juridico, repositorio-prompts

#### ‚úÖ SUBTAREFA 4: Controle de Acesso

**Arquivo atualizado:** `config/auth.php`

**Fun√ß√µes criadas:**

1. **`has_vertical_access(string $vertical): bool`**
   - Verifica se usu√°rio tem acesso a uma vertical espec√≠fica
   - Considera usu√°rios demo (acesso total)

2. **`has_tool_access(string $tool_slug): bool`**
   - Verifica se usu√°rio tem acesso a uma ferramenta espec√≠fica
   - Usa mapeamento tool‚Üíverticals

3. **`get_user_tools(): array`**
   - Retorna lista de ferramentas dispon√≠veis para o usu√°rio
   - Baseado na vertical selecionada
   - Retorna array com metadados (id, nome, descri√ß√£o, √≠cone, url)

**Dashboard atualizado:** `public/dashboard.php`
- Substitu√≠da se√ß√£o hardcoded de ferramentas por sistema din√¢mico
- Usa `get_user_tools()` para filtrar ferramentas
- Mostra vertical do usu√°rio e badge "Modo Demo" se aplic√°vel
- Link direto para √°rea da vertical
- Alerta se onboarding pendente

#### ‚úÖ SUBTAREFA 5: Monitoramento B√°sico

**Arquivo criado:** `public/admin/analytics.php`

**Funcionalidades:**

1. **Estat√≠sticas Gerais** (cards):
   - Total de usu√°rios
   - Usu√°rios que completaram onboarding
   - Acessos √∫ltimos 30 dias
   - Total de acessos hist√≥rico

2. **Solicita√ß√µes Pendentes**:
   - Lista de solicita√ß√µes de acesso ao Jur√≠dico
   - Detalhes expand√≠veis (profiss√£o, OAB, escrit√≥rio, motivo)
   - Badge de contagem

3. **Top 10 Ferramentas** (√∫ltimos 30 dias):
   - Ordenado por n√∫mero de acessos
   - Mostra total de acessos e usu√°rios √∫nicos

4. **Acessos por Vertical** (√∫ltimos 30 dias):
   - Agrupado por vertical
   - Total de acessos e usu√°rios √∫nicos

5. **Distribui√ß√£o de Usu√°rios**:
   - Cards com total de usu√°rios por vertical

6. **√öltimos 50 Acessos**:
   - Tabela com timestamp, usu√°rio, email, ferramenta, vertical
   - Ordenado por data decrescente

**Seguran√ßa:**
- Apenas usu√°rios admin podem acessar
- Redirecionamento autom√°tico se n√£o autorizado

---

## üóÇÔ∏è Arquivos Criados/Modificados

### Criados (21 arquivos principais)

**Migrations & Scripts:**
- `config/migrations/001_vertical_system.sql`
- `config/migrations/README.md`
- `scripts/apply-migration.php`
- `scripts/generate-vertical-indexes.php`
- `scripts/generate-tool-gateways.php`

**Onboarding:**
- `public/onboarding-step1.php`
- `public/onboarding-step2.php`
- `public/onboarding-save-vertical.php`
- `public/onboarding-ifrj.php`
- `public/onboarding-juridico.php`

**Verticais (index.php):**
- `public/areas/docencia/index.php`
- `public/areas/pesquisa/index.php`
- `public/areas/ifrj-alunos/index.php`
- `public/areas/juridico/index.php`
- `public/areas/vendas/index.php`
- `public/areas/marketing/index.php`
- `public/areas/licitacoes/index.php`
- `public/areas/rh/index.php`
- `public/areas/geral/index.php`

**Admin:**
- `public/admin/analytics.php`

**Gateways de Ferramentas (16 arquivos):**
- Gerados automaticamente via script (ver SUBTAREFA 3)

### Modificados (3 arquivos)

- `config/auth.php` - Adicionadas 3 fun√ß√µes de controle de acesso
- `public/callback.php` - Verifica√ß√£o de onboarding + redirecionamento inteligente
- `public/dashboard.php` - Sistema din√¢mico de ferramentas por vertical

---

## üöÄ Pr√≥ximos Passos (Testar e Deploar)

### 1. Aplicar Migration

```bash
# IMPORTANTE: Fazer backup antes!
mysqldump -u usuario -p plataforma_sunyata > backup_pre_migration.sql

# Aplicar migration
php scripts/apply-migration.php

# Confirmar quando solicitado
```

### 2. Testes Locais

**Teste 1: Onboarding Completo**
- [ ] Login com conta Google nova
- [ ] Verificar redirecionamento para onboarding-step1.php
- [ ] Preencher dados pessoais e avan√ßar
- [ ] Escolher vertical "Doc√™ncia"
- [ ] Verificar redirecionamento para /areas/docencia/
- [ ] Verificar que ferramentas corretas aparecem

**Teste 2: Onboarding IFRJ**
- [ ] Login com conta nova
- [ ] Completar step 1
- [ ] Escolher "IFRJ - Alunos"
- [ ] Preencher n√≠vel e curso
- [ ] Verificar acesso √†s ferramentas corretas

**Teste 3: Onboarding Jur√≠dico**
- [ ] Login com conta nova
- [ ] Completar step 1
- [ ] Escolher "Jur√≠dico"
- [ ] Preencher formul√°rio de solicita√ß√£o
- [ ] Verificar mensagem de sucesso
- [ ] Verificar que email foi enviado
- [ ] Verificar que aparece em /admin/analytics.php como pendente

**Teste 4: Controle de Acesso**
- [ ] Usu√°rio da vertical "Pesquisa" N√ÉO pode acessar ferramentas de "Jur√≠dico"
- [ ] Tentar acessar diretamente URL de gateway restrito
- [ ] Verificar que dashboard mostra apenas ferramentas permitidas

**Teste 5: Demo User**
- [ ] Admin marcar usu√°rio como demo (UPDATE users SET is_demo = TRUE WHERE id = X)
- [ ] Verificar que demo user v√™ TODAS as ferramentas
- [ ] Verificar badge "Modo Demo" no dashboard

**Teste 6: Analytics**
- [ ] Login como admin
- [ ] Acessar /admin/analytics.php
- [ ] Verificar que estat√≠sticas aparecem corretamente
- [ ] Realizar alguns acessos a ferramentas
- [ ] Atualizar analytics e verificar que logs foram registrados

### 3. Deploy para Produ√ß√£o

```bash
# 1. Fazer backup do banco de produ√ß√£o
ssh usuario@servidor
mysqldump -u usuario -p plataforma_sunyata > backup_producao_$(date +%Y%m%d_%H%M%S).sql

# 2. Fazer upload dos novos arquivos
# (Via FTP, rsync, git pull, etc)

# 3. Aplicar migration em produ√ß√£o
php scripts/apply-migration.php

# 4. Verificar logs de erro
tail -f /var/log/apache2/error.log

# 5. Testar funcionalidades cr√≠ticas
```

---

## üìù Notas Importantes

### Usu√°rios Existentes

**Problema:** Usu√°rios que j√° estavam cadastrados n√£o t√™m `completed_onboarding = TRUE`.

**Solu√ß√£o Tempor√°ria:**
```sql
-- Marcar todos os usu√°rios existentes como tendo completado onboarding
-- E atribuir vertical "geral" por padr√£o
UPDATE users
SET completed_onboarding = TRUE,
    selected_vertical = 'geral'
WHERE completed_onboarding = FALSE;
```

**Ou for√ßar todos a refazer onboarding:**
```sql
-- Deixar como est√° (completed_onboarding = FALSE)
-- Todos ter√£o que escolher vertical no pr√≥ximo login
```

### Configura√ß√£o de Email

O sistema envia emails quando h√° solicita√ß√£o de acesso ao Jur√≠dico. Verifique que:
- Fun√ß√£o `mail()` est√° configurada no servidor
- Ou configure SMTP no PHP

### Verticais "Em Breve"

As seguintes verticais mostram p√°gina "Em breve":
- Vendas
- Marketing
- Licita√ß√µes
- RH
- Geral

Para ativar, alterar `'disponivel' => true` em:
- `public/onboarding-step2.php`
- Adicionar ferramentas ao mapeamento em `config/auth.php::get_user_tools()`

### Ferramentas HTML

O sistema espera que os arquivos HTML das ferramentas existam em:
```
public/ferramentas/
‚îú‚îÄ‚îÄ canvas-docente.html
‚îú‚îÄ‚îÄ canvas-pesquisa.html
‚îú‚îÄ‚îÄ canvas-juridico.html
‚îú‚îÄ‚îÄ biblioteca-prompts-jogos.html
‚îú‚îÄ‚îÄ guia-prompts-jogos.html
‚îú‚îÄ‚îÄ guia-prompts-juridico.html
‚îî‚îÄ‚îÄ padroes-avancados-juridico.html
```

Se algum arquivo n√£o existir, o gateway mostrar√° erro 404 amig√°vel.

---

## üîê Seguran√ßa

### CSRF Protection
- Todos os formul√°rios usam `csrf_token()`
- Valida√ß√£o via `verify_csrf()`

### SQL Injection
- Todas as queries usam prepared statements via `Database` class

### Access Control
- Verifica√ß√£o de login em todas as p√°ginas: `require_login()`
- Verifica√ß√£o de vertical em gateways
- Admin pages verificam `access_level === 'admin'`

### Audit Logs
- Todos os acessos a ferramentas s√£o registrados
- A√ß√µes de onboarding s√£o auditadas
- Conformidade com LGPD

---

## üìä M√©tricas P√≥s-Deploy

**Acompanhar:**
1. Taxa de conclus√£o do onboarding
2. Distribui√ß√£o de usu√°rios por vertical
3. Ferramentas mais acessadas
4. Solicita√ß√µes de acesso ao Jur√≠dico
5. Taxa de rejei√ß√£o/aprova√ß√£o de solicita√ß√µes

**Acesso via:** `https://portal.sunyataconsulting.com/admin/analytics.php`

---

## üÜò Troubleshooting

### Erro: "Ferramenta n√£o encontrada"
- Verificar se arquivo HTML existe em `public/ferramentas/`
- Verificar permiss√µes (644 para arquivos)

### Erro: "Voc√™ n√£o tem acesso a esta vertical"
- Verificar `users.selected_vertical` no banco
- Verificar se onboarding foi completado
- Verificar mapeamento em `config/auth.php`

### Onboarding n√£o redireciona
- Verificar `users.completed_onboarding` no banco
- Verificar `callback.php` linha 42-44
- Verificar sess√£o: `$_SESSION['user']['completed_onboarding']`

### Analytics n√£o mostra dados
- Verificar se `tool_access_logs` tem registros
- Verificar se gateways est√£o registrando acessos
- Verificar se view `v_tool_access_stats` foi criada

---

## üéØ FASE 2 (Pr√≥ximas Implementa√ß√µes)

**N√£o implementado ainda (escopo futuro):**

1. **Interface para aprovar/rejeitar solicita√ß√µes**
   - P√°gina admin para gerenciar `vertical_access_requests`
   - Enviar email ao usu√°rio quando aprovado/rejeitado

2. **Refinamento do Jur√≠dico**
   - Valida√ß√£o de OAB via API da OAB
   - Diferentes n√≠veis de acesso dentro do Jur√≠dico

3. **Admin Interface para Analytics**
   - Gr√°ficos interativos (Chart.js)
   - Exporta√ß√£o de relat√≥rios
   - Filtros por per√≠odo

4. **Notifica√ß√µes**
   - Email quando vertical liberada
   - Email quando nova ferramenta adicionada
   - Notifica√ß√µes in-app

---

## ‚úÖ Conclus√£o

**Status:** ‚úÖ FASE 1 COMPLETA

Todas as 5 subtarefas foram implementadas com sucesso. O sistema est√° pronto para testes locais e deploy para produ√ß√£o.

**Pr√≥ximo passo:** Aplicar migration no banco de dados e iniciar testes.

---

**Documento gerado em:** Outubro 2025
**Vers√£o:** 1.0
**Autor:** Claude Code + Equipe Sunyata
